import pytest
import numpy as np
from utils.binary_phase import get_binary_phase

def test_get_binary_phase():
    mjd = 58916.326063833455837
    ephemeris_dict = {
        "PSRJ": "J1915+1606",
        "RAJ": "19:15:27.9980670",
        "RAJ_ERR": 3e-05,
        "DECJ": "+16:06:27.37364",
        "DECJ_ERR": 0.0005,
        "F0": 16.94055165104785,
        "F0_ERR": 3.22225794107241e-06,
        "F1": -2.4733e-15,
        "F1_ERR": 1e-19,
        "PEPOCH": 58774.0,
        "POSEPOCH": 58774.0,
        "DMEPOCH": 58774.0,
        "DM": 168.77,
        "DM_ERR": 0.01,
        "PMRA": -1.23,
        "PMRA_ERR": 0.04,
        "PMDEC": -0.83,
        "PMDEC_ERR": 0.04,
        "BINARY": "DDH",
        "PB": 0.322997448918,
        "PB_ERR": 3e-12,
        "T0": 52144.90097849,
        "T0_ERR": 3e-08,
        "A1": 2.341782,
        "A1_ERR": 3e-06,
        "OM": 292.5445,
        "OM_ERR": 8e-05,
        "ECC": 0.617134,
        "ECC_ERR": 4e-07,
        "EDOT": 6e-16,
        "EDOT_ERR": 7e-16,
        "PBDOT": -2.423e-12,
        "PBDOT_ERR": 1e-15,
        "OMDOT": 4.226585,
        "OMDOT_ERR": 4e-06,
        "GAMMA": 4.307e-06,
        "GAMMA_ERR": 4e-09,
        "START": "2019-10-18T14:34:21.495627Z",
        "FINISH": "2019-10-18T14:37:23.115452Z",
        "TRACK": 1.0,
        "TZRMJD": 58774.60809149166,
        "TZRFRQ": 1309.028,
        "TZRSITE": "meerkat",
        "DTHETA": 4e-06,
        "DTHETA_ERR": 2.5e-06,
        "TRES": 22.675,
        "EPHVER": 5.0,
        "H3": 6e-07,
        "H3_ERR": 1e-07,
        "STIG": 0.38,
        "STIG_ERR": 0.04,
        "CLK": "TT(TAI)",
        "MODE": 1.0,
        "UNITS": "TDB",
        "TIMEEPH": "IF99",
        "DILATEFREQ": "Y",
        "PLANET_SHAPIRO": "Y",
        "T2CMETHOD": "TEMPO",
        "NE_SW": 4.0,
        "CORRECT_TROPOSPHERE": "N",
        "EPHEM": "DE405",
        "NITS": 1.0,
        "NTOA": 6.0,
        "CHI2R": 0.4071,
        "CHI2R_ERR": 4.0,
        "P0": 0.05902995,
        "P0_ERR": 1e-08
    }
    binry_phase = get_binary_phase(np.array([float(mjd)]), ephemeris_dict)[0]
    assert binry_phase == pytest.approx(0.47618863436144104315, rel=1e-6)
